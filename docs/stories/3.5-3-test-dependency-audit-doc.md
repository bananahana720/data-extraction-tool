# Story 3.5.3: Test Dependency Audit Documentation

Status: review

## Story

As a developer preparing for a new epic with unfamiliar libraries,
I want a documented test-dependency audit process with automated checklist hooks,
so that environment/tool readiness is validated systematically instead of relying on tribal knowledge.

### Story Header

- **Story Key:** `3.5-3-test-dependency-audit-doc` (Epic 3.5, Story ID 3.5.3)
- **Context:** Addresses Epic 3 retrospective finding that undocumented dependency audit process creates risk as semantic toolchain grows. [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L37-L39]
- **Dependencies:** Epic 2.5 spaCy integration examples (template for process doc)
- **Estimate:** 3 hours
- **Owner:** Winston

### Story Body

Implementation will create `docs/processes/test-dependency-audit.md` documenting the systematic process for validating new library dependencies before epic development starts. The doc will include a checklist template (library installation, smoke tests, CI cache configuration, performance baseline measurement, documentation updates) based on Epic 2.5's successful spaCy integration pattern. An automated pre-commit hook will link to this process doc when new dependencies are detected in `pyproject.toml`, ensuring developers follow the documented workflow. [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L50]

## Acceptance Criteria

1. **Process doc exists:** `docs/processes/test-dependency-audit.md` committed with complete dependency audit workflow. [Source: docs/tech-spec-epic-3.5.md#L29-L30]
2. **Checklist template:** Doc includes step-by-step checklist covering library installation, smoke tests, CI caching, baselines, docs. [Source: docs/tech-spec-epic-3.5.md#L29-L30]
3. **Epic 2.5 examples:** References spaCy integration (Story 2.5.2) as concrete example of the process in action. [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L50]
4. **Automated hook:** Pre-commit hook detects `pyproject.toml` dependency changes and reminds developers to follow audit process. [Source: docs/tech-spec-epic-3.5.md#L29-L30]
5. **Story template integration:** Dependency audit checklist linked from story template wiring section (Story 3.5.1 coordination). [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L50]

## Tasks / Subtasks

- [x] **Task 1: Analyze Epic 2.5 spaCy integration (AC: 3)**
  - [x] Review Story 2.5.2 implementation (spaCy model download, smoke tests, CI caching)
  - [x] Extract reusable patterns from spaCy integration approach
  - [x] Document lessons learned from that dependency addition
  - [x] Identify common pitfalls to warn about in process doc

- [x] **Task 2: Write dependency audit process doc (AC: 1-2)**
  - [x] Create `docs/processes/test-dependency-audit.md` structure
  - [x] Document step-by-step checklist: installation, smoke tests, CI config, baselines, docs
  - [x] Include spaCy integration as worked example
  - [x] Add troubleshooting section for common dependency issues
  - [x] Define when audit is required (new libraries, major version upgrades)

- [x] **Task 3: Create automated hook (AC: 4)**
  - [x] Create pre-commit hook that detects `pyproject.toml` changes
  - [x] Hook outputs reminder to follow test-dependency-audit.md process
  - [x] Add hook configuration to `.pre-commit-config.yaml`
  - [x] Test hook triggers on dependency additions/changes

- [x] **Task 4: Integration and validation (AC: 5)**
  - [x] Coordinate with Story 3.5.1 to link audit doc from story template wiring checklist
  - [x] Validate doc is discoverable via `docs/processes/` directory
  - [x] QA review for completeness and clarity

## AC Evidence Table

| AC# | Description | Status | Evidence |
|-----|-------------|--------|----------|
| AC-1 | Process doc exists at `docs/processes/test-dependency-audit.md` | ✅ COMPLETE | File created with 259 lines, 7-phase comprehensive checklist covering all aspects of dependency validation |
| AC-2 | Doc includes step-by-step checklist | ✅ COMPLETE | Document contains Phase 1-7 with detailed checklists: Pre-installation (security/version), Installation, Smoke Tests, CI/CD, Documentation, Integration Testing, Final Validation |
| AC-3 | References spaCy integration as example | ✅ COMPLETE | Section "Epic 2.5 spaCy Integration Example" provides complete walkthrough of Story 2.5.2 with 10 steps and key lessons learned |
| AC-4 | Pre-commit hook detects pyproject.toml changes | ✅ COMPLETE | Hook implemented (`scripts/check_dependency_changes.py`), configured in `.pre-commit-config.yaml`, tested with integration script, shows reminder message |
| AC-5 | Story template integration | ✅ COMPLETE | Updated `scripts/generate_story_template.py` to include "If adding dependencies, follow docs/processes/test-dependency-audit.md" in BOM section of wiring checklist |

## Dev Notes

### Requirements Context Summary

- **Retrospective finding:** Dependency audit doc still absent (deferred from Epic 2, no owner); risk of future epics missing env/tool setup. [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L23-L24]
- **Significant discovery:** Undocumented dependency audit process means relying on tribal knowledge; unacceptable as semantic toolchain grows. [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L37-L39]
- **Action plan item #3:** Create test-dependency audit process doc + checklist hook by 2025-11-22 with Winston ownership. [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L50]

### Structure Alignment Summary

- Process doc follows existing `docs/processes/` directory structure (currently empty, this establishes the pattern).
- Epic 2.5.2 (spaCy integration) provides concrete example: model download, smoke tests, CI caching, performance validation.
- Hook extends existing pre-commit infrastructure for consistent enforcement.

### References

- `docs/retrospectives/epic-3-retro-2025-11-16.md#L23-L24, L37-L39, L50` – Retrospective findings and action plan
- `docs/stories/2.5-2-spacy-integration-and-end-to-end-testing.md` – spaCy integration example
- `.claude/CLAUDE.md#spacy-model-setup` – Existing spaCy documentation as template
- `docs/tech-spec-epic-3.5.md#L29-L30` – Process doc requirements

## Dev Agent Record

### Context Reference

- docs/stories/3.5-3-test-dependency-audit-doc.context.xml (generated 2025-11-17)
- docs/retrospectives/epic-3-retro-2025-11-16.md
- docs/stories/2.5-2-spacy-integration-and-end-to-end-testing.md
- docs/tech-spec-epic-3.5.md

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

Session 2025-11-17: Story 3.5.3 drafted from Epic 3.5 tech spec and retrospective action plan.

Session 2025-11-18: Task 1 - Analyzed Epic 2.5 spaCy integration pattern from Story 2.5.2. Extracted reusable patterns:
- Pre-installation security check (CVE scan)
- Version constraint specification in pyproject.toml with inline comments for traceability
- Post-installation validation commands (e.g., python -m spacy validate)
- Model download and verification steps
- Performance baseline measurement (load time, throughput)
- Smoke test script creation with specific thresholds
- CI integration with caching strategy
- Documentation updates in multiple locations (CLAUDE.md, README.md, troubleshooting guide)
- Integration test coverage for error handling

### Completion Notes List

- **2025-11-17:** Story created with 5 ACs, 4 task groups, references to spaCy integration and retrospective.
- **2025-11-18:** Story implementation complete. All 5 ACs satisfied. Process doc created with comprehensive 7-phase checklist, pre-commit hook implemented and tested, integration with Story 3.5.1 template generator completed. Quality gates pass (Black/Ruff/Mypy clean).

### File List

**Created:**
- `docs/stories/3.5-3-test-dependency-audit-doc.md` (this document)
- `docs/processes/test-dependency-audit.md` (259 lines - comprehensive dependency audit process)
- `scripts/check_dependency_changes.py` (118 lines - pre-commit hook for dependency changes)
- `scripts/test_dependency_hook.py` (87 lines - integration test script)

**Modified:**
- `.pre-commit-config.yaml` (added check-dependency-changes hook)
- `scripts/generate_story_template.py` (added reference to audit process in wiring checklist)
- `docs/sprint-status.yaml` (updated story status to in-progress)
