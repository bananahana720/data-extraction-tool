<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3.5</epicId>
    <storyId>3.5.1</storyId>
    <title>Story/Review Template Generator</title>
    <status>todo</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/3.5-1-story-review-template-generator.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>development team member working on data-extraction-tool stories</asA>
    <iWant>automated story and review templates that embed development guidelines</iWant>
    <soThat>I don't miss critical elements like provenance tracking, structured logging, and AC evidence collection</soThat>
    <tasks>
### Task 1: Create Story Template (AC: #3.5.1-1)
- [ ] Create `bmad/bmm/templates/` directory if not exists
- [ ] Create `story-template.md.j2` with Jinja2 syntax
- [ ] Add all required sections (Story, Context, AC with evidence tables, Tasks, Dev Notes)
- [ ] Add inline reminder comments:
  - Provenance: "Remember to add source_hash and processing_version to data models"
  - Logging: "Emit structlog events for key operations (see LOGGING_GUIDE.md)"
  - Wiring: "Wire new components into pipeline, update CLI commands if needed"
  - AC Evidence: "Collect evidence during implementation - don't wait for review!"
- [ ] Add Jinja2 variables: `{{ story_id }}`, `{{ title }}`, `{{ epic }}`, `{{ owner }}`, etc.
- [ ] Validate template syntax (render with sample data)

### Task 2: Create Review Template (AC: #3.5.1-2)
- [ ] Create `review-template.md.j2` with checklist structure
- [ ] Add quality gate checklist items (black, ruff, mypy, pytest)
- [ ] Add performance baseline checklist (reference epic performance docs)
- [ ] Add AC evidence validation checklist
- [ ] Add provenance audit checklist
- [ ] Add logging audit checklist
- [ ] Add integration test checklist
- [ ] Add documentation update checklist
- [ ] Validate template syntax (render with sample data)

### Task 3: Implement CLI Scaffolding Tool (AC: #3.5.1-3)
- [ ] Create `bmad/bmm/tools/` directory if not exists
- [ ] Create `scaffold-story.py` script with argparse CLI
- [ ] Implement YAML schema validation using Pydantic
- [ ] Implement template rendering using Jinja2
- [ ] Implement file writing with path resolution (docs/stories/, etc.)
- [ ] Add optional --review flag to generate review template
- [ ] Add comprehensive docstrings and type hints
- [ ] Add usage examples in docstring

### Task 4: Create Unit Tests (AC: #3.5.1-1, #3.5.1-2)
- [ ] Create `tests/unit/test_bmad/test_templates.py`
- [ ] Test story template renders with sample YAML data
- [ ] Test review template renders with sample YAML data
- [ ] Test template includes all required sections
- [ ] Test template variables are substituted correctly
- [ ] Test invalid YAML config raises validation error

### Task 5: Create Integration Tests (AC: #3.5.1-3, #3.5.1-4)
- [ ] Create `tests/integration/test_bmad/test_scaffold_story.py`
- [ ] Test scaffold-story.py generates story file in correct location
- [ ] Test generated story file has correct content
- [ ] Test --review flag generates review template
- [ ] Test YAML schema validation catches errors
- [ ] Test integration with BMAD workflow task invocation

### Task 6: Create Documentation and Examples (AC: #3.5.1-5)
- [ ] Create `bmad/bmm/templates/README.md` with usage instructions
- [ ] Document YAML schema with all fields and types
- [ ] Document template variables and their usage
- [ ] Create `bmad/bmm/templates/examples/` directory
- [ ] Add example YAML configs (simple story, complex story, review-only)
- [ ] Add examples to README

### Task 7: Quality Gates and UAT
- [ ] Run black, ruff, mypy on all new code (0 violations)
- [ ] Run unit tests with coverage (>80% for new code)
- [ ] Run integration tests
- [ ] UAT: Team review of story template (AC-3.5.1-1)
- [ ] UAT: Use review template for Story 3.5.2 review (AC-3.5.1-2)
- [ ] UAT: Team review of README documentation (AC-3.5.1-5)
    </tasks>
  </story>

  <acceptanceCriteria>
**AC-3.5.1-1: Story Markdown Template Created (P0 - Critical)**
- Template file created at `bmad/bmm/templates/story-template.md.j2` (Jinja2 format)
- Sections include:
  - Story header (title, status, epic, owner, dates)
  - Story statement (As a..., I want..., So that...)
  - Context Summary (Epic Context, Business Value, Dependencies, Technical Foundation, Key Requirements)
  - Acceptance Criteria with evidence tables (AC ID, Description, Evidence Type, Evidence Location, Status)
  - AC Trade-offs and Deferrals section
  - Tasks/Subtasks with checkboxes
  - Dev Notes section (provenance reminders, logging patterns, quality gate commands)
- Template includes inline comments reminding developers to:
  - Add provenance tracking (source_hash, processing_version) to data models
  - Emit structlog events for audit trail
  - Wire new components into pipeline/CLI
  - Collect AC evidence during implementation (not post-review)
- **Validation:** Unit test verifies template renders valid markdown, includes all required sections
- **UAT Required:** Yes - Review template with team, validate inline reminders are helpful

**AC-3.5.1-2: Review Checklist Template Created (P0)**
- Template file created at `bmad/bmm/templates/review-template.md.j2`
- Checklist includes:
  - Quality gates validation (black, ruff, mypy, pytest with coverage)
  - Performance baseline checks (reference to docs/performance-baselines-epic-*.md)
  - AC evidence validation (all ACs have evidence entries with locations)
  - Provenance audit (source_hash, processing_version present in outputs)
  - Logging audit (structlog events emitted for key operations)
  - Integration test coverage (end-to-end scenarios tested)
  - Documentation updates (CLAUDE.md, tech specs, architecture.md)
- **Validation:** Unit test verifies template renders valid markdown, includes all sections
- **UAT Required:** Yes - Use template for Story 3.5.2 review

**AC-3.5.1-3: CLI Scaffolding Tool Implemented (P1)**
- Python script created at `bmad/bmm/tools/scaffold-story.py`
- Accepts YAML config file with story metadata:
  ```yaml
  story_id: "3.5.2"
  title: "CLAUDE.md Lessons Section"
  epic: "3.5"
  owner: "Bob"
  priority: "P1"
  complexity: "Small (2-4h)"
  dependencies: ["Epic 3 Complete"]
  ```
- Generates story file at `docs/stories/{story_id}-{slug}.md` from template
- Optionally generates review file at `docs/uat/reviews/{story_id}-review.md`
- Validates YAML schema before rendering
- **Validation:** Integration test scaffolds sample story, verifies file created with correct content
- **UAT Required:** No - Integration test sufficient

**AC-3.5.1-4: Templates Integrate with BMAD Workflows (P2)**
- Story template variables compatible with BMAD workflow variable resolution
- Templates can be invoked from BMAD workflows via `<invoke-task name="scaffold-story" />`
- Generated files follow existing naming conventions (kebab-case, numeric prefixes)
- **Validation:** Integration test invokes template from test workflow, verifies output
- **UAT Required:** No - Integration test sufficient

**AC-3.5.1-5: Documentation and Examples Provided (P1)**
- README created at `bmad/bmm/templates/README.md` explaining:
  - How to use scaffold-story.py CLI
  - YAML schema for story metadata
  - Template variable reference
  - Example usage scenarios
- Example YAML configs in `bmad/bmm/templates/examples/`
- **Validation:** Manual review of documentation completeness
- **UAT Required:** Yes - Team reviews README, confirms clarity
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/epic-3.5-bridge-epic-summary.md</path>
        <title>Epic 3.5: Bridge Epic - Tooling &amp; Semantic Prep</title>
        <section>Epic Overview</section>
        <snippet>Epic 3.5 is a bridge epic between Epic 3 (Chunk &amp; Output) and Epic 4 (Foundational Semantic Analysis). It addresses action items and preparation tasks identified in the Epic 3 retrospective (2025-11-16), ensuring Epic 4 can start without blockers or mid-sprint delays.</snippet>
      </doc>
      <doc>
        <path>docs/retrospectives/epic-3-retro-2025-11-16.md</path>
        <title>Epic 3 Retrospective</title>
        <section>Challenges &amp; Root Causes</section>
        <snippet>Missing provenance/metadata reminders in story templates: Markdown skeletons created manually; no enforced sections for BOM, config snapshot, wiring tasks. AC 3.4-6/3.5-7 initially failed; extra review cycles. AC evidence added post-review: No tooling to prompt authors to fill AC table before status change; QA + SM burn time verifying after-the-fact.</snippet>
      </doc>
      <doc>
        <path>docs/retrospectives/epic-3-retro-2025-11-16.md</path>
        <title>Epic 3 Retrospective</title>
        <section>Action Plan (SMART)</section>
        <snippet>Action #1: scripts/new-story generator (story markdown + AC table + wiring checklist + submission summary). Owner: Elena + DevOps. Deadline: 2025-11-20. Success Criteria: Script outputs ready-to-edit files; Story 4.1 uses it.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic Summary</section>
        <snippet>5 Epics Delivering Complete MVP: Foundation, Normalization, Chunking, Semantic Analysis, CLI UX. Epic 3 (Chunk &amp; Output) complete with 7 stories. Epic 3.5 (Bridge Epic) prepares tooling for Epic 4.</snippet>
      </doc>
      <doc>
        <path>docs/archive/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>Auditability (NFR-A1)</section>
        <snippet>Processing Traceability: Every output chunk traceable to source file and location. Processing configuration persisted with outputs. Timestamp and version information for all processing. Complete audit trail from input to output.</snippet>
      </doc>
      <doc>
        <path>.claude/CLAUDE.md</path>
        <title>Project Instructions</title>
        <section>Code Conventions</section>
        <snippet>Required: Type hints on all public functions. Google-style docstrings for public APIs. Tests for all new functionality. Pre-commit compliance (black, ruff, mypy must pass).</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>pyproject.toml</path>
        <kind>config</kind>
        <symbol>dependencies</symbol>
        <lines>36-60</lines>
        <reason>Current project dependencies - Jinja2 NOT present, needs to be added. Pydantic v2 already available for YAML validation.</reason>
      </artifact>
      <artifact>
        <path>pyproject.toml</path>
        <kind>config</kind>
        <symbol>dev dependencies</symbol>
        <lines>72-87</lines>
        <reason>Development dependencies including pytest, black, ruff, mypy - all tools referenced in story quality gates and review template.</reason>
      </artifact>
      <artifact>
        <path>.claude/CLAUDE.md</path>
        <kind>doc</kind>
        <symbol>Code Conventions</symbol>
        <lines>208-222</lines>
        <reason>Code conventions that should be embedded in story templates (naming, type hints, docstrings, pre-commit compliance).</reason>
      </artifact>
      <artifact>
        <path>.claude/CLAUDE.md</path>
        <kind>doc</kind>
        <symbol>Quality Gates</symbol>
        <lines>208-221</lines>
        <reason>Quality gate commands (black, ruff, mypy, pytest) that should be included in both story template Dev Notes and review template checklist.</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="jinja2" version=">=3.1.0" status="missing">Template rendering engine - MUST BE ADDED to pyproject.toml dependencies</package>
        <package name="pydantic" version=">=2.0.0,&lt;3.0" status="present">Already in project - use for YAML schema validation</package>
        <package name="PyYAML" version=">=6.0.0,&lt;7.0" status="present">Already in project - use for YAML config file parsing</package>
        <package name="pytest" version=">=8.0.0,&lt;9.0" status="present">Already in dev dependencies - use for unit/integration tests</package>
        <package name="black" version=">=24.0.0,&lt;25.0" status="present">Already in dev dependencies - referenced in quality gates</package>
        <package name="ruff" version=">=0.6.0,&lt;0.7" status="present">Already in dev dependencies - referenced in quality gates</package>
        <package name="mypy" version=">=1.11.0,&lt;2.0" status="present">Already in dev dependencies - referenced in quality gates</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Python 3.12+ mandatory (enterprise requirement)</constraint>
    <constraint>All new code must pass pre-commit hooks (black, ruff, mypy) with 0 violations</constraint>
    <constraint>Unit test coverage >80% for new code (greenfield standard)</constraint>
    <constraint>Templates must use Jinja2 syntax (industry standard, Python ecosystem compatibility)</constraint>
    <constraint>YAML-first approach for metadata (non-interactive by default, automation/workflow friendly)</constraint>
    <constraint>Generated files must follow existing naming conventions (kebab-case with numeric prefixes)</constraint>
    <constraint>Templates must embed development guidelines (provenance, logging, wiring, AC evidence) as inline reminders</constraint>
    <constraint>Story template must include AC evidence table structure (prevents post-review backfilling identified in Epic 3 retro)</constraint>
    <constraint>Review template must reference quality gates, performance baselines, and documentation update requirements</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>ScaffoldStory CLI</name>
      <kind>command-line tool</kind>
      <signature>
python bmad/bmm/tools/scaffold-story.py --config CONFIG_FILE [--review]
      </signature>
      <path>bmad/bmm/tools/scaffold-story.py</path>
    </interface>
    <interface>
      <name>YAML Configuration Schema</name>
      <kind>data contract</kind>
      <signature>
story_id: str (e.g., "3.5.2")
title: str
epic: str
owner: str
priority: str (P0, P1, P2)
complexity: str (e.g., "Small (2-4h)")
dependencies: List[str]
      </signature>
      <path>bmad/bmm/templates/schema.yaml (implied)</path>
    </interface>
    <interface>
      <name>Jinja2 Template Variables</name>
      <kind>template interface</kind>
      <signature>
{{ story_id }}
{{ title }}
{{ epic }}
{{ owner }}
{{ priority }}
{{ complexity }}
{{ dependencies }}
{{ date }}
      </signature>
      <path>bmad/bmm/templates/story-template.md.j2</path>
    </interface>
    <interface>
      <name>BMAD Workflow Task Invocation</name>
      <kind>workflow integration</kind>
      <signature>
&lt;invoke-task name="scaffold-story" config="story-config.yaml" /&gt;
      </signature>
      <path>BMAD workflow instructions (XML/markdown)</path>
    </interface>
  </interfaces>

  <tests>
    <standards>
Testing standards for this story follow project conventions:
- Unit tests in `tests/unit/test_bmad/test_templates.py` for template rendering validation
- Integration tests in `tests/integration/test_bmad/test_scaffold_story.py` for end-to-end scaffolding
- Pytest framework with markers (unit, integration)
- Coverage requirement: >80% for new code (greenfield standard)
- Quality gates: black, ruff, mypy must pass with 0 violations
- UAT required for AC-3.5.1-1, AC-3.5.1-2, AC-3.5.1-5 (team review and validation)
    </standards>
    <locations>
      <location>tests/unit/test_bmad/</location>
      <location>tests/integration/test_bmad/</location>
      <location>bmad/bmm/templates/examples/ (example configs for testing)</location>
    </locations>
    <ideas>
      <test ac="AC-3.5.1-1">
        <description>Unit test: Story template renders with sample YAML data and includes all required sections</description>
        <approach>Create sample YAML with all fields, render template, verify sections present (Story, Context, AC with evidence table, Tasks, Dev Notes)</approach>
      </test>
      <test ac="AC-3.5.1-1">
        <description>Unit test: Story template includes inline reminder comments (provenance, logging, wiring, AC evidence)</description>
        <approach>Render template and assert specific reminder strings are present in output</approach>
      </test>
      <test ac="AC-3.5.1-2">
        <description>Unit test: Review template renders with sample data and includes all checklist items</description>
        <approach>Render template, verify presence of quality gates, performance baselines, AC evidence, provenance, logging, integration tests, documentation sections</approach>
      </test>
      <test ac="AC-3.5.1-3">
        <description>Integration test: scaffold-story.py generates story file in correct location with correct content</description>
        <approach>Run CLI with sample YAML config, verify output file created at docs/stories/{story_id}-{slug}.md with expected content</approach>
      </test>
      <test ac="AC-3.5.1-3">
        <description>Integration test: scaffold-story.py with --review flag generates review template</description>
        <approach>Run CLI with --review flag, verify review file created at docs/uat/reviews/{story_id}-review.md</approach>
      </test>
      <test ac="AC-3.5.1-3">
        <description>Unit test: Invalid YAML config raises validation error</description>
        <approach>Provide YAML with missing required fields or invalid types, assert Pydantic ValidationError raised</approach>
      </test>
      <test ac="AC-3.5.1-4">
        <description>Integration test: Template invoked from BMAD workflow produces expected output</description>
        <approach>Create test workflow XML with &lt;invoke-task name="scaffold-story" /&gt;, execute, verify output files created</approach>
      </test>
      <test ac="AC-3.5.1-5">
        <description>UAT: Team reviews README for clarity and completeness</description>
        <approach>Manual review session with team members (Elena, Bob, Charlie, Dana), collect feedback, iterate until approved</approach>
      </test>
    </ideas>
  </tests>
</story-context>
