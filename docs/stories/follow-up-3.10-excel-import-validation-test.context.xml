<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>3.10</storyId>
    <title>Add Excel Import Validation Test</title>
    <status>done</status>
    <generatedAt>2025-11-17</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/follow-up-3.10-excel-import-validation-test.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>auditor</asA>
    <iWant>CSV output to load cleanly into Excel without manual cleanup</iWant>
    <soThat>I can immediately pivot, filter, and analyze chunk data</soThat>
    <tasks>
      <task id="1">Generate CSV file using CsvFormatter</task>
      <task id="2">Convert CSV to Excel using openpyxl</task>
      <task id="3">Load Excel file and validate schema</task>
      <task id="4">Test special character preservation</task>
      <task id="5">Test formula injection prevention</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-3.10-1" priority="P1">
      <given>CSV file generated by CsvFormatter</given>
      <when>File loaded via openpyxl (Excel library)</when>
      <then>Workbook loads without errors, all 10 columns present with correct headers, all rows accessible</then>
    </criterion>
    <criterion id="AC-3.10-2" priority="P1">
      <given>Loaded Excel workbook</given>
      <when>Schema inspected</when>
      <then>Column headers match canonical schema, cell data types correct</then>
    </criterion>
    <criterion id="AC-3.10-3" priority="P1">
      <given>CSV with special characters (commas, quotes, newlines, emoji, Chinese, Arabic)</given>
      <when>Loaded into Excel</when>
      <then>All special characters preserved correctly (no corruption)</then>
    </criterion>
    <criterion id="AC-3.10-4" priority="P2">
      <given>CSV with potentially dangerous content (=SUM, @IMPORTXML)</given>
      <when>Loaded into Excel</when>
      <then>Content treated as text (not executed as formula)</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/traceability-matrix-epic-3.md</path>
        <title>Traceability Matrix &amp; Quality Assessment - Epic 3</title>
        <section>AC-3.6-4: Import Validation</section>
        <snippet>Coverage: PARTIAL - Tests validate Python csv.DictReader, pandas.read_csv, and csvkit. Excel/Sheets manual UAT identified as Gap 3.</snippet>
      </doc>
      <doc>
        <path>docs/stories/3-6-csv-output-format-for-analysis-and-tracking.md</path>
        <title>Story 3.6: CSV Output Format</title>
        <section>Acceptance Criteria</section>
        <snippet>Defined canonical 10-column CSV schema and parser validation requirements that Story 3.10 extends with Excel validation.</snippet>
      </doc>
      <doc>
        <path>docs/test-design-epic-3.md</path>
        <title>Test Design: Epic 3 - Chunk &amp; Output Stages</title>
        <section>Risk R-010</section>
        <snippet>CSV export with very long chunks may be truncated in Excel. Mitigation: Optional truncation with indicator.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>tests/unit/test_output/test_csv_formatter.py</path>
        <kind>test</kind>
        <symbol>CsvFormatter</symbol>
        <lines>1-235</lines>
        <reason>Existing CSV formatter tests define interface and expected behavior that Excel validation tests must align with</reason>
      </artifact>
      <artifact>
        <path>tests/unit/test_output/test_csv_parser_validator.py</path>
        <kind>test</kind>
        <symbol>CsvParserValidator</symbol>
        <lines>1-121</lines>
        <reason>Current CSV parser validation tests that Story 3.10 extends with openpyxl-based Excel validation</reason>
      </artifact>
      <artifact>
        <path>tests/integration/test_output/test_csv_pipeline.py</path>
        <kind>test</kind>
        <symbol>test_csv_output_pipeline</symbol>
        <lines>1-50</lines>
        <reason>End-to-end CSV pipeline tests that Excel validation should integrate with</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <core>
          <openpyxl>^3.0.10</openpyxl>
          <pandas>^2.0.0</pandas>
          <csvkit>^2.0.0</csvkit>
        </core>
        <testing>
          <pytest>^8.0.0</pytest>
          <pytest-cov>^5.0.0</pytest-cov>
        </testing>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Tests must be placed in tests/integration/test_output/test_csv_compatibility.py per Story 3.10 specification</constraint>
    <constraint>Must test formula injection prevention by escaping leading =, +, -, @ characters</constraint>
    <constraint>Must preserve UTF-8-sig encoding for Windows Excel compatibility</constraint>
    <constraint>CSV must adhere to canonical 10-column schema from Story 3.6</constraint>
    <constraint>Test files exceeding 300 lines require refactoring per Story 3.9 DoD compliance</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>CsvFormatter</name>
      <kind>class</kind>
      <signature>CsvFormatter(max_text_length: int = None, validate: bool = True)</signature>
      <path>data_extract.output.formatters.csv_formatter</path>
    </interface>
    <interface>
      <name>CsvParserValidator</name>
      <kind>class</kind>
      <signature>CsvParserValidator.validate(csv_path: Path) -> CsvParserValidationReport</signature>
      <path>data_extract.output.validation.csv_parser</path>
    </interface>
    <interface>
      <name>FormatResult</name>
      <kind>dataclass</kind>
      <signature>FormatResult(path: Path, format_type: str, chunks_written: int, metadata: dict)</signature>
      <path>data_extract.output.formatters.base</path>
    </interface>
  </interfaces>

  <tests>
    <standards>Use pytest with fixtures for test data. Follow unit/integration/performance test organization. Mirror src/ structure in tests/. Use markers (unit, integration, output). Require 80%+ coverage for greenfield code. Pre-commit hooks must pass (black, ruff, mypy).</standards>
    <locations>
      <location>tests/integration/test_output/test_csv_compatibility.py</location>
      <location>tests/unit/test_output/test_csv_*.py</location>
      <location>tests/integration/test_output/</location>
    </locations>
    <ideas>
      <idea ac="AC-3.10-1">Test Excel workbook loads without errors using openpyxl</idea>
      <idea ac="AC-3.10-2">Validate 10-column schema matches canonical definition</idea>
      <idea ac="AC-3.10-3">Test special character preservation (emoji, Chinese, Arabic)</idea>
      <idea ac="AC-3.10-4">Test formula injection prevention with dangerous content</idea>
      <idea ac="AC-3.10-1">Test csv_to_excel conversion function</idea>
      <idea ac="AC-3.10-2">Verify data type preservation (text vs numeric)</idea>
      <idea ac="AC-3.10-3">Test multiline text handling in Excel cells</idea>
      <idea ac="AC-3.10-4">Test apostrophe prefixing for formula escape</idea>
    </ideas>
  </tests>
</story-context>