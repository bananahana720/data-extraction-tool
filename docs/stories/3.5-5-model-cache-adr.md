# Story 3.5.5: Model/Cache ADR

Status: backlog

## Story

As an architect designing Epic 4 semantic analysis infrastructure,
I want an Architecture Decision Record defining model cache storage paths, versioning, and CLI integration,
so that TF-IDF/LSA model persistence follows consistent patterns and avoids cache invalidation issues.

### Story Header

- **Story Key:** `3.5-5-model-cache-adr` (Epic 3.5, Story ID 3.5.5)
- **Context:** Epic 4 semantic models require caching strategy to avoid recomputation overhead (10-100x speedup). [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L57]
- **Dependencies:** Story 3.5.4 (semantic dependencies installed)
- **Estimate:** 4 hours
- **Owner:** Winston

### Story Body

Implementation will create ADR-012 documenting the semantic model cache and persistence strategy. The ADR will define cache storage locations (development, CI, production), cache key patterns with hash-based invalidation (corpus content SHA-256 + model version), size limits (500 MB max with LRU eviction), and CLI integration (`--clear-cache` flag). The decision will use joblib for model persistence based on its scikit-learn integration and pickle protocol support. The ADR must address cache drift prevention and coordinate with Epic 5 configuration system for path customization. [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L57]

## Acceptance Criteria

1. **ADR created:** `docs/architecture/adr-012-semantic-model-cache.md` committed following ADR template (Context, Decision, Consequences, Alternatives). [Source: docs/tech-spec-epic-3.5.md#L186-L222]
2. **Storage paths defined:** Cache locations for development (`.data-extract-cache/models/`), CI (`~/.cache/data-extract/models/`), production (env var configurable). [Source: docs/tech-spec-epic-3.5.md#L192-L195]
3. **Cache key pattern:** Defines hash-based keys with model version + corpus hash (e.g., `tfidf_v1_{corpus_hash}.joblib`). [Source: docs/tech-spec-epic-3.5.md#L197-L201]
4. **Size limits:** Specifies 500 MB max cache size with LRU eviction and 80% warning threshold. [Source: docs/tech-spec-epic-3.5.md#L203-L207]
5. **CLI integration:** Documents `--clear-cache` flag and cache status reporting approach. [Source: docs/tech-spec-epic-3.5.md#L201, L209-L211]
6. **Architect review:** ADR reviewed and approved by project architect before Epic 4 starts. [Source: docs/tech-spec-epic-3.5.md#L250-L251]

## Tasks / Subtasks

- [ ] **Task 1: Research cache requirements (AC: 1)**
  - [ ] Analyze Epic 4 semantic processor cache needs (TF-IDF, LSA, similarity matrices)
  - [ ] Estimate model sizes for typical corpus (1k-10k documents)
  - [ ] Review joblib documentation for persistence patterns
  - [ ] Identify cache invalidation scenarios (corpus changes, model version upgrades)

- [ ] **Task 2: Draft ADR content (AC: 2-5)**
  - [ ] Write Context section: Epic 4 model caching requirements, performance goals
  - [ ] Write Decision section: joblib persistence, storage paths, cache keys, size limits
  - [ ] Write Consequences section: speedup benefits, disk usage trade-offs, invalidation complexity
  - [ ] Write Alternatives section: SQLite, no caching, in-memory only (with rejection rationale)
  - [ ] Include code examples for cache key generation and invalidation

- [ ] **Task 3: CLI integration design (AC: 5)**
  - [ ] Document `--clear-cache` flag behavior (removes all cached models)
  - [ ] Design cache status reporting (disk usage, model count, oldest/newest models)
  - [ ] Define cache warming strategy (optional pre-computation for common corpora)
  - [ ] Document cache directory management (automatic creation, gitignore updates)

- [ ] **Task 4: Review and coordination (AC: 6)**
  - [ ] Coordinate with Epic 5 config system design for env var integration
  - [ ] Submit ADR for architect review
  - [ ] Address review feedback and update ADR
  - [ ] Ensure ADR is discoverable via `docs/architecture/` directory

## Dev Notes

### Requirements Context Summary

- **Retrospective prep task #2:** Model/similarity cache ADR (storage paths, versioning, CLI integration) – 4h, Winston. [Source: docs/retrospectives/epic-3-retro-2025-11-16.md#L57]
- **Performance goal:** 10-100x speedup on repeated analysis (0.1s vs. 10s for TF-IDF fit). [Source: docs/tech-spec-epic-3.5.md#L213]
- **Epic 4 dependency:** Cannot implement semantic processor without cache strategy (repeated computation unacceptable). [Source: docs/tech-spec-epic-3.5.md#L45-L67]

### Structure Alignment Summary

- ADR follows existing ADR template in `docs/architecture/architecture-decision-records-adrs.md`.
- Cache paths align with existing `.data-extract-cache/` gitignored directory pattern.
- CLI flags coordinate with Epic 5 CLI refactoring for consistent UX.

### References

- `docs/retrospectives/epic-3-retro-2025-11-16.md#L57` – Preparation sprint task #2
- `docs/tech-spec-epic-3.5.md#L186-L222` – Cache ADR template and requirements
- `docs/architecture/architecture-decision-records-adrs.md` – ADR template and existing ADRs
- `.gitignore` – Cache directory exclusions

## Dev Agent Record

### Context Reference

- docs/retrospectives/epic-3-retro-2025-11-16.md
- docs/tech-spec-epic-3.5.md
- docs/architecture/architecture-decision-records-adrs.md

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

Session 2025-11-17: Story 3.5.5 drafted from Epic 3.5 tech spec and retrospective preparation tasks.

### Completion Notes List

- **2025-11-17:** Story created with 6 ACs, 4 task groups, references to retrospective and tech spec.

### File List

**Created:**
- `docs/stories/3.5-5-model-cache-adr.md` (this document)
