# Story 3.5.1: Story/Review Template Generator

Status: ready-for-dev

## Dev Agent Record
**Context Reference:**
- docs/stories/3-5-1-story-review-template-generator.context.xml (generated 2025-11-17)

**Agent Assignments:**
- **Primary Agent:** Paige (tech-writer) - `/bmad:bmm:agents:tech-writer`
  - Tasks: 1, 2, 6 (Template creation and documentation)
  - Responsible for: Creating story-template.md.j2, review-template.md.j2, README.md, examples
- **Secondary Agent:** Amelia (dev) - `/bmad:bmm:agents:dev`
  - Tasks: 3, 4, 5, 7 (Implementation and testing)
  - Responsible for: scaffold-story.py CLI tool, unit tests, integration tests, quality gates

**Primary Workflow:**
- `/bmad:bmm:workflows:dev-story` - Execute story implementation with continuous development
- Invoke via Amelia's menu: `*develop-story`

**Story Owner:** Elena + DevOps (Epic 3 retrospective action item)

## Story

As a **development team member working on data-extraction-tool stories**,
I want **automated story and review templates that embed development guidelines**,
so that **I don't miss critical elements like provenance tracking, structured logging, and AC evidence collection**.

## Context Summary

**Epic Context:** Story 3.5.1 is the first story in Epic 3.5 (Bridge Epic - Tooling & Semantic Prep), which prepares the project for Epic 4 (Foundational Semantic Analysis). This story addresses a key insight from the Epic 3 retrospective: "Story templates lacked reminders for provenance/logging/wiring" causing "AC evidence often backfilled post-review, causing rework."

**Business Value:**
- Reduces rework by ensuring developers include AC evidence tables during implementation (not post-review)
- Embeds best practices (provenance tracking, structured logging, quality gates) directly into story scaffolding
- Accelerates QA sign-off by standardizing documentation format
- Frees developers to focus on complex implementation rather than remembering checklist items

**Dependencies:**
- **Epic 3 Complete (Chunk & Output)** - All 7 stories completed, retrospective findings documented
- **BMAD UAT Framework (Story 2.5.3.1)** - UAT workflows provide structure for review templates
- **Quality Gate Automation (Story 2.5.3)** - Pre-commit, mypy, ruff checks that templates should reference
- **Epic 3 Retrospective (2025-11-16)** - Action item: "Story/Review Template Generator (Owner: Elena + DevOps)"

**Technical Foundation:**
- **Jinja2 templating** - Industry-standard Python templating engine
- **YAML configuration** - Story metadata (title, owner, epic, priority, complexity)
- **CLI scaffolding tool** - Invoke template generator from command line or workflow
- **Git integration** - Templates create files in correct directories (docs/stories/, docs/uat/test-cases/)

**Key Requirements:**
1. **Story Template:** Markdown template with sections for Story, Context, AC with evidence tables, Tasks, Dev Notes
2. **Review Template:** Code review checklist template referencing quality gates, performance baselines, AC validation
3. **CLI Scaffolding:** Command-line tool to generate story/review files from YAML input
4. **Guideline Embedding:** Templates include inline comments/reminders for provenance, logging, wiring
5. **Integration:** Works with BMAD workflows and existing story structure

## Acceptance Criteria

**AC-3.5.1-1: Story Markdown Template Created (P0 - Critical)**
- Template file created at `bmad/bmm/templates/story-template.md.j2` (Jinja2 format)
- Sections include:
  - Story header (title, status, epic, owner, dates)
  - Story statement (As a..., I want..., So that...)
  - Context Summary (Epic Context, Business Value, Dependencies, Technical Foundation, Key Requirements)
  - Acceptance Criteria with evidence tables (AC ID, Description, Evidence Type, Evidence Location, Status)
  - AC Trade-offs and Deferrals section
  - Tasks/Subtasks with checkboxes
  - Dev Notes section (provenance reminders, logging patterns, quality gate commands)
- Template includes inline comments reminding developers to:
  - Add provenance tracking (source_hash, processing_version) to data models
  - Emit structlog events for audit trail
  - Wire new components into pipeline/CLI
  - Collect AC evidence during implementation (not post-review)
- **Validation:** Unit test verifies template renders valid markdown, includes all required sections
- **UAT Required:** Yes - Review template with team, validate inline reminders are helpful

**AC-3.5.1-2: Review Checklist Template Created (P0)**
- Template file created at `bmad/bmm/templates/review-template.md.j2`
- Checklist includes:
  - Quality gates validation (black, ruff, mypy, pytest with coverage)
  - Performance baseline checks (reference to docs/performance-baselines-epic-*.md)
  - AC evidence validation (all ACs have evidence entries with locations)
  - Provenance audit (source_hash, processing_version present in outputs)
  - Logging audit (structlog events emitted for key operations)
  - Integration test coverage (end-to-end scenarios tested)
  - Documentation updates (CLAUDE.md, tech specs, architecture.md)
- **Validation:** Unit test verifies template renders valid markdown, includes all sections
- **UAT Required:** Yes - Use template for Story 3.5.2 review

**AC-3.5.1-3: CLI Scaffolding Tool Implemented (P1)**
- Python script created at `bmad/bmm/tools/scaffold-story.py`
- Accepts YAML config file with story metadata:
  ```yaml
  story_id: "3.5.2"
  title: "CLAUDE.md Lessons Section"
  epic: "3.5"
  owner: "Bob"
  priority: "P1"
  complexity: "Small (2-4h)"
  dependencies: ["Epic 3 Complete"]
  ```
- Generates story file at `docs/stories/{story_id}-{slug}.md` from template
- Optionally generates review file at `docs/uat/reviews/{story_id}-review.md`
- Validates YAML schema before rendering
- **Validation:** Integration test scaffolds sample story, verifies file created with correct content
- **UAT Required:** No - Integration test sufficient

**AC-3.5.1-4: Templates Integrate with BMAD Workflows (P2)**
- Story template variables compatible with BMAD workflow variable resolution
- Templates can be invoked from BMAD workflows via `<invoke-task name="scaffold-story" />`
- Generated files follow existing naming conventions (kebab-case, numeric prefixes)
- **Validation:** Integration test invokes template from test workflow, verifies output
- **UAT Required:** No - Integration test sufficient

**AC-3.5.1-5: Documentation and Examples Provided (P1)**
- README created at `bmad/bmm/templates/README.md` explaining:
  - How to use scaffold-story.py CLI
  - YAML schema for story metadata
  - Template variable reference
  - Example usage scenarios
- Example YAML configs in `bmad/bmm/templates/examples/`
- **Validation:** Manual review of documentation completeness
- **UAT Required:** Yes - Team reviews README, confirms clarity

## Acceptance Criteria Trade-offs and Deferrals

**AC-3.5.1-3 Trade-off (YAML vs Interactive):**
- **Issue:** CLI could accept YAML config OR interactive prompts for story metadata
- **Resolution:** YAML-first approach (non-interactive) for automation/workflow integration
- **Rationale:** Interactive mode can be added in Epic 5 if needed; YAML enables scripting
- **Documented In:** Dev Notes, scaffold-story.py docstring

**AC-3.5.1-4 Deferred to Epic 5:**
- **Full workflow integration** with create-story workflow deferred until Epic 5 CLI work
- **Interim:** Templates can be manually invoked or used via simple task wrapper
- **Rationale:** Epic 5 will refactor BMAD workflows; avoid rework by waiting

## Tasks / Subtasks

### Task 1: Create Story Template (AC: #3.5.1-1)
- [ ] Create `bmad/bmm/templates/` directory if not exists
- [ ] Create `story-template.md.j2` with Jinja2 syntax
- [ ] Add all required sections (Story, Context, AC with evidence tables, Tasks, Dev Notes)
- [ ] Add inline reminder comments:
  - Provenance: "Remember to add source_hash and processing_version to data models"
  - Logging: "Emit structlog events for key operations (see LOGGING_GUIDE.md)"
  - Wiring: "Wire new components into pipeline, update CLI commands if needed"
  - AC Evidence: "Collect evidence during implementation - don't wait for review!"
- [ ] Add Jinja2 variables: `{{ story_id }}`, `{{ title }}`, `{{ epic }}`, `{{ owner }}`, etc.
- [ ] Validate template syntax (render with sample data)

### Task 2: Create Review Template (AC: #3.5.1-2)
- [ ] Create `review-template.md.j2` with checklist structure
- [ ] Add quality gate checklist items (black, ruff, mypy, pytest)
- [ ] Add performance baseline checklist (reference epic performance docs)
- [ ] Add AC evidence validation checklist
- [ ] Add provenance audit checklist
- [ ] Add logging audit checklist
- [ ] Add integration test checklist
- [ ] Add documentation update checklist
- [ ] Validate template syntax (render with sample data)

### Task 3: Implement CLI Scaffolding Tool (AC: #3.5.1-3)
- [ ] Create `bmad/bmm/tools/` directory if not exists
- [ ] Create `scaffold-story.py` script with argparse CLI
- [ ] Implement YAML schema validation using Pydantic
- [ ] Implement template rendering using Jinja2
- [ ] Implement file writing with path resolution (docs/stories/, etc.)
- [ ] Add optional --review flag to generate review template
- [ ] Add comprehensive docstrings and type hints
- [ ] Add usage examples in docstring

### Task 4: Create Unit Tests (AC: #3.5.1-1, #3.5.1-2)
- [ ] Create `tests/unit/test_bmad/test_templates.py`
- [ ] Test story template renders with sample YAML data
- [ ] Test review template renders with sample YAML data
- [ ] Test template includes all required sections
- [ ] Test template variables are substituted correctly
- [ ] Test invalid YAML config raises validation error

### Task 5: Create Integration Tests (AC: #3.5.1-3, #3.5.1-4)
- [ ] Create `tests/integration/test_bmad/test_scaffold_story.py`
- [ ] Test scaffold-story.py generates story file in correct location
- [ ] Test generated story file has correct content
- [ ] Test --review flag generates review template
- [ ] Test YAML schema validation catches errors
- [ ] Test integration with BMAD workflow task invocation

### Task 6: Create Documentation and Examples (AC: #3.5.1-5)
- [ ] Create `bmad/bmm/templates/README.md` with usage instructions
- [ ] Document YAML schema with all fields and types
- [ ] Document template variables and their usage
- [ ] Create `bmad/bmm/templates/examples/` directory
- [ ] Add example YAML configs (simple story, complex story, review-only)
- [ ] Add examples to README

### Task 7: Quality Gates and UAT
- [ ] Run black, ruff, mypy on all new code (0 violations)
- [ ] Run unit tests with coverage (>80% for new code)
- [ ] Run integration tests
- [ ] UAT: Team review of story template (AC-3.5.1-1)
- [ ] UAT: Use review template for Story 3.5.2 review (AC-3.5.1-2)
- [ ] UAT: Team review of README documentation (AC-3.5.1-5)

## Dev Notes

**Provenance Tracking:**
- Templates themselves don't need source_hash (static files)
- Generated story files should include template version in header comment
- scaffold-story.py should log generation timestamp and template version

**Structured Logging:**
- scaffold-story.py should emit structlog events:
  - `template_generation_start` (story_id, output_path)
  - `template_validation_complete` (yaml_schema_valid=True/False)
  - `file_written` (file_path, size_bytes)
  - `template_generation_complete` (story_id, duration_ms)

**Pipeline Wiring:**
- Templates are standalone tools, not part of main extraction pipeline
- Integration point is BMAD workflows (invoke-task mechanism)
- Epic 5 may integrate more deeply into CLI

**Quality Gates:**
```bash
# Format check
black bmad/bmm/templates/ bmad/bmm/tools/ tests/unit/test_bmad/ tests/integration/test_bmad/

# Lint check
ruff check bmad/bmm/templates/ bmad/bmm/tools/ tests/unit/test_bmad/ tests/integration/test_bmad/

# Type check
mypy bmad/bmm/tools/

# Run tests
pytest tests/unit/test_bmad/test_templates.py -v
pytest tests/integration/test_bmad/test_scaffold_story.py -v
```

**Performance Considerations:**
- Template rendering is fast (<10ms for typical story)
- YAML parsing is fast (<5ms for typical config)
- File I/O is dominant cost (<50ms total)
- No performance baselines needed (not in critical path)

**Dependencies:**
- Add to pyproject.toml: `jinja2>=3.1.0` (if not already present)
- Pydantic v2 already in project (use for YAML validation)

**Testing Strategy:**
- Unit tests: Template rendering, YAML validation
- Integration tests: End-to-end scaffolding, file creation
- UAT: Team uses templates for real stories (3.5.2+)

**Edge Cases:**
- Missing YAML fields: Use defaults or raise validation error
- Invalid story_id format: Validate pattern (e.g., "3.5.2")
- File already exists: Prompt for overwrite confirmation
- Invalid output path: Create parent directories if needed

**Retrospective Learnings Applied:**
- This story directly addresses "Story templates lacked reminders for provenance/logging/wiring"
- Templates embed guidelines so developers don't forget critical elements
- AC evidence tables are front-and-center in template (not backfilled)
- Review template ensures consistent quality gate validation

**Next Story Dependencies:**
- Story 3.5.2 (CLAUDE.md Lessons) can use this template to validate format
- Story 3.5.3+ can be scaffolded using this tool
