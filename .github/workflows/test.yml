# CI Pipeline for Data Extraction Tool
# Runs on every push and pull request
# Enforces quality gates: tests, coverage, linting, type checking, formatting

name: Test & Quality Checks

on:
  push:
    branches: [main, develop, "feature/**"]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Tests & Coverage
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.12", "3.13"]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache spaCy models
        uses: actions/cache@v4
        with:
          path: ~/.cache/spacy
          key: ${{ runner.os }}-spacy-3.7.2-en_core_web_md
          restore-keys: |
            ${{ runner.os }}-spacy-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          python -m spacy download en_core_web_md

      - name: Run unit tests
        run: |
          pytest -m unit --cov=src --cov-report=term --cov-report=xml -v

      - name: Run integration tests
        run: |
          pytest -m integration --cov=src --cov-append --cov-report=term --cov-report=xml -v

      - name: Run remaining tests
        run: |
          pytest -m "not unit and not integration" --cov=src --cov-append --cov-report=term --cov-report=xml --cov-report=html \
            --ignore=tests/performance/test_cli_benchmarks.py -v

      - name: Validate coverage threshold
        run: |
          coverage report --fail-under=60 || {
            echo "❌ Coverage below 60% threshold"
            echo "Current coverage: $(coverage report | grep TOTAL | awk '{print $4}')"
            echo "Review coverage report in artifacts for details"
            exit 1
          }

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-${{ matrix.python-version }}
          fail_ci_if_error: false

      - name: Upload coverage HTML artifact
        uses: actions/upload-artifact@v4
        if: matrix.python-version == '3.12'
        with:
          name: coverage-report
          path: htmlcov/

      # Coverage threshold is enforced by pytest.ini (fail_under=60)
      # No need to duplicate here - pytest --cov will fail if threshold not met

  lint:
    name: Linting (Ruff)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          pip install ruff~=0.6.0

      - name: Run ruff linter
        run: |
          ruff check src/ tests/ --output-format=github

  type-check:
    name: Type Checking (Mypy)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy~=1.11.0 pydantic>=2.0.0 types-PyYAML types-python-dotenv

      - name: Run mypy type checker
        run: |
          mypy src/data_extract/ --python-version=3.12

  format-check:
    name: Format Checking (Black)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install black
        run: |
          python -m pip install --upgrade pip
          pip install black~=24.0

      - name: Run black format check
        run: |
          black --check --line-length=100 src/ tests/

  pre-commit:
    name: Pre-commit Hooks Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Run pre-commit on all files
        run: |
          pre-commit run --all-files

  status-check:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [test, lint, type-check, format-check, pre-commit]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.lint.result }}" != "success" ] || \
             [ "${{ needs.type-check.result }}" != "success" ] || \
             [ "${{ needs.format-check.result }}" != "success" ] || \
             [ "${{ needs.pre-commit.result }}" != "success" ]; then
            echo "❌ One or more quality checks failed"
            exit 1
          else
            echo "✅ All quality checks passed"
          fi
